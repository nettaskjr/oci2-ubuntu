name: Restart K8s Pod (via Zero Trust)

on:
    workflow_dispatch:
        inputs:
            namespace:
                description: "Kubernetes Namespace"
                required: true
                default: "portainer"
            label_selector:
                description: "Label Selector (ex: app=portainer)"
                required: true
                default: "app=portainer"

jobs:
    restart-pod:
        runs-on: ubuntu-latest
        name: Restart Pod over Zero Trust SSH
        steps:
            - name: Install Cloudflared
              run: |
                  # Baixa e instala o cliente cloudflared no Runner
                  curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
                  sudo dpkg -i cloudflared.deb

            - name: Setup SSH Key
              run: |
                  mkdir -p ~/.ssh
                  # Salva a chave privada do Secret para arquivo
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519

                  # Configura SSH para usar o ProxyCloudflared com Service Token
                  # Isso permite acesso sem login interativo no browser
                  cat <<EOF > ~/.ssh/config
                  Host remote-server
                    HostName ${{ secrets.SSH_HOST }}
                    User ${{ secrets.SSH_USER }}
                    IdentityFile ~/.ssh/id_ed25519
                    StrictHostKeyChecking no
                    ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_CLIENT_ID }} --secret ${{ secrets.CF_CLIENT_SECRET }}
                  EOF

            - name: Delete Pod (Trigger Restart)
              run: |
                  echo "Conectando via Tunnel para reiniciar pod..."
                  echo "Namespace: ${{ inputs.namespace }}"
                  echo "Label: ${{ inputs.label_selector }}"

                  # Executa comando remoto via SSH
                  ssh remote-server "sudo k3s kubectl delete pod -n ${{ inputs.namespace }} -l ${{ inputs.label_selector }}"
